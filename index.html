<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Moldura nas Fotos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- exif-js para ler metadados -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <!-- JSZip CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- PWA meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
  </head>
  <body class="bg-neutral-100 min-h-screen flex flex-col items-center justify-center p-0">
    <main class="w-full max-w-md bg-white rounded-none shadow-none p-0 flex flex-col gap-4 min-h-screen">
      <form id="uploadForm" class="flex flex-col gap-2 px-4 pt-8 pb-2">
        <div class="flex flex-row gap-2 mb-2">
          <label class="flex items-center gap-2 text-sm font-medium text-gray-700">
            <input type="radio" name="outputRatio" value="1:1" checked class="accent-indigo-600" />
            Quadrado 1:1
          </label>
          <label class="flex items-center gap-2 text-sm font-medium text-gray-700">
            <input type="radio" name="outputRatio" value="9:16" class="accent-indigo-600" />
            Stories 9:16
          </label>
        </div>
        <label class="block">
          <input id="fileInput" type="file" accept="image/*" multiple class="mt-2 block w-full text-base text-gray-700 file:mr-4 file:py-3 file:px-4 file:rounded-xl file:border-0 file:text-base file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
        </label>
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition text-base w-full">Adicionar Moldura</button>
        <button id="downloadZipBtn" class="hidden bg-gray-100 hover:bg-gray-200 text-indigo-700 font-bold py-3 px-4 rounded-xl transition text-base w-full border border-indigo-200 mt-2">Baixar todas em ZIP</button>
      </form>
      <div id="thumbsGrid" class="hidden grid grid-cols-2 gap-4 px-4 mt-4"></div>
      <div id="previewArea" class="hidden flex-col items-center gap-4 px-4">
        <canvas id="canvasPreview" width="400" height="400" class="rounded-xl shadow-lg border-4 border-indigo-400"></canvas>
        <div id="exifInfo" class="text-xs text-gray-600 text-center"></div>
        <button id="downloadBtn" class="mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">Baixar Foto com Moldura</button>
      </div>
    </main>
    <!-- Overlay para visualiza√ß√£o em tela cheia -->
    <div id="imageOverlay" class="fixed inset-0 bg-black bg-opacity-90 flex-col items-center justify-center z-50 hidden">
      <img id="overlayImg" src="" alt="Imagem em tela cheia" class="max-w-full max-h-[80vh] rounded-xl shadow-lg mx-auto mt-20" />
      <p class="text-white text-center mt-4 text-base font-medium">Toque e segure a imagem para salvar</p>
      <button id="closeOverlayBtn" class="mt-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition mx-auto block">Fechar</button>
    </div>
    <footer class="mt-6 text-gray-400 text-xs text-center pb-2">Feito com ‚ù§Ô∏è por Gabriel Sicuro</footer>

    <script>
      // Porcentagem do lado ocupado pela foto
      const IMG_RATIO = 0.9;
      const PREVIEW_SIZE = 400;

      const uploadForm = document.getElementById('uploadForm');
      const fileInput = document.getElementById('fileInput');
      const previewArea = document.getElementById('previewArea');
      const canvasPreview = document.getElementById('canvasPreview');
      const ctxPreview = canvasPreview.getContext('2d');
      const downloadBtn = document.getElementById('downloadBtn');
      const exifInfoDiv = document.getElementById('exifInfo');
      const thumbsGrid = document.getElementById('thumbsGrid');

      let imgOriginal = null;
      let finalImageReady = false;
      let exifText = '';

      // Fun√ß√£o para montar texto das infos EXIF com tracinhos estilo Flickr
      function getExifText(tags) {
        const parts = [];
        // Marca + modelo
        if (tags.Make || tags.Model) parts.push((tags.Make||'') + ' ' + (tags.Model||''));
        // Dist√¢ncia focal
        if (tags.FocalLength) parts.push(tags.FocalLength + 'mm');
        // f/N√∫mero
        if (tags.FNumber) parts.push('f/' + tags.FNumber);
        // Tempo de exposi√ß√£o
        if (tags.ExposureTime) {
          let exp = tags.ExposureTime;
          // Se for string tipo '1/250', mant√©m
          if (typeof exp === 'string' && exp.indexOf('/') > -1) {
            exp = exp + 's';
          } else if (typeof exp === 'number') {
            if (exp < 1 && exp > 0) {
              // Converter decimal para fra√ß√£o (ex: 0.0125 => 1/80s)
              const denom = Math.round(1/exp);
              exp = `1/${denom}s`;
            } else {
              exp = exp.toFixed(1) + 's';
            }
          }
          parts.push(exp);
        }
        // ISO
        if (tags.ISOSpeedRatings) parts.push('ISO ' + tags.ISOSpeedRatings);
        return parts.join(' ‚Äî ');
      }

      // Fun√ß√£o para montar HTML das infos EXIF com √≠cones estilo Flickr
      function getExifHtml(tags) {
        const parts = [];
        // Marca + modelo
        if (tags.Make || tags.Model) parts.push('<span class="exif-icon">üì∑</span> ' + (tags.Make||'') + ' ' + (tags.Model||''));
        // Dist√¢ncia focal
        if (tags.FocalLength) parts.push('<span class="exif-icon">üî≠</span> ' + tags.FocalLength + 'mm');
        // f/N√∫mero
        if (tags.FNumber) parts.push('<span class="exif-icon">üåô</span> f/' + tags.FNumber);
        // Tempo de exposi√ß√£o
        if (tags.ExposureTime) {
          let exp = tags.ExposureTime;
          if (typeof exp === 'number') {
            exp = exp >= 1 ? exp.toFixed(1) + 's' : ('1/' + Math.round(1/exp) + 's');
          } else if (typeof exp === 'string' && exp.indexOf('/') > -1) {
            exp = exp + 's';
          }
          parts.push('<span class="exif-icon">‚è±Ô∏è</span> ' + exp);
        }
        // ISO
        if (tags.ISOSpeedRatings) parts.push('<span class="exif-icon">üåÄ</span> ISO ' + tags.ISOSpeedRatings);
        return parts.join(' &nbsp;&nbsp;&nbsp; '); // Espa√ßo extra entre infos
      }

      // NOVO: Multi-foto e thumbs
      fileInput.addEventListener('change', function (e) {
        const files = Array.from(fileInput.files);
        thumbsGrid.innerHTML = '';
        if (files.length === 0) {
          thumbsGrid.classList.add('hidden');
          document.getElementById('downloadZipBtn').classList.add('hidden');
          return;
        }
        thumbsGrid.classList.remove('hidden');
        document.getElementById('downloadZipBtn').classList.remove('hidden');
        // Armazenar infos de cada imagem
        window._zipImages = [];
        files.forEach((file, idx) => {
          const reader = new FileReader();
          reader.onload = function (evt) {
            const img = new Image();
            img.onload = function () {
              // Cria thumb canvas
              const thumbCanvas = document.createElement('canvas');
              thumbCanvas.width = 160;
              thumbCanvas.height = 160;
              const thumbCtx = thumbCanvas.getContext('2d');
              thumbCtx.fillStyle = '#fff';
              thumbCtx.fillRect(0, 0, 160, 160);
              let tw, th;
              if (img.width > img.height) {
                tw = 144;
                th = (img.height / img.width) * 144;
              } else {
                th = 144;
                tw = (img.width / img.height) * 144;
              }
              thumbCtx.drawImage(img, (160-tw)/2, (160-th)/2, tw, th);
              // Container da thumb
              const thumbDiv = document.createElement('div');
              thumbDiv.className = 'flex flex-col items-center bg-gray-50 rounded-xl shadow p-2 cursor-pointer hover:ring-4 hover:ring-blue-400 transition relative';
              thumbDiv.appendChild(thumbCanvas);

              // Bot√£o remover (X)
              const removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.title = 'Remover foto';
              removeBtn.innerHTML = '&times;';
              removeBtn.className = 'absolute top-1 right-2 text-xl text-gray-400 hover:text-red-500 font-bold bg-white bg-opacity-80 rounded-full w-7 h-7 flex items-center justify-center shadow-sm z-10';
              thumbDiv.appendChild(removeBtn);

              // Checkbox para mostrar infos
              const infoToggle = document.createElement('input');
              infoToggle.type = 'checkbox';
              infoToggle.id = 'infoToggle'+idx;
              infoToggle.className = 'mt-2';
              const infoLabel = document.createElement('label');
              infoLabel.htmlFor = infoToggle.id;
              infoLabel.innerText = 'Exibir infos';
              infoLabel.className = 'ml-2 text-xs text-gray-600';

              // Div para infos
              const infoDiv = document.createElement('div');
              infoDiv.className = 'text-xs text-gray-600 text-center mt-1 hidden';
              thumbDiv.appendChild(infoToggle);
              thumbDiv.appendChild(infoLabel);
              thumbDiv.appendChild(infoDiv);

              // Bot√£o de download individual
              const downloadThumbBtn = document.createElement('button');
              downloadThumbBtn.type = 'button';
              downloadThumbBtn.innerText = 'Baixar';
              downloadThumbBtn.className = 'mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg text-xs transition';
              thumbDiv.appendChild(downloadThumbBtn);

              let exifForThis = '';
              infoToggle.addEventListener('change', function() {
                if (infoToggle.checked) {
                  EXIF.getData(file, function () {
                    const allExif = EXIF.getAllTags(this);
                    exifForThis = getExifText(allExif);
                    infoDiv.textContent = exifForThis || 'Sem informa√ß√µes.';
                    infoDiv.classList.remove('hidden');
                  });
                } else {
                  infoDiv.classList.add('hidden');
                  exifForThis = '';
                }
              });

              // Clique na thumb abre overlay de visualiza√ß√£o
              thumbDiv.addEventListener('click', function(e) {
                // Evita conflito ao clicar nos bot√µes/checkbox dentro da thumb
                if (e.target === thumbDiv || e.target === thumbCanvas) {
                  const url = generateCanvasUrl(img, infoToggle, exifForThis, idx);
                  const overlay = document.getElementById('imageOverlay');
                  const overlayImg = document.getElementById('overlayImg');
                  overlayImg.src = url;
                  overlay.classList.remove('hidden');
                  overlay.classList.add('flex');
                }
              });

              // Download individual corrigido
              downloadThumbBtn.addEventListener('click', function(ev) {
                ev.stopPropagation();
                const url = generateCanvasUrl(img, infoToggle, exifForThis, idx);
                const link = document.createElement('a');
                link.download = `foto-moldurada-1x1-${idx+1}.png`;
                link.href = url;
                document.body.appendChild(link);
                link.click();
                setTimeout(() => document.body.removeChild(link), 100);
              });

              // Remover thumb e atualizar lista
              removeBtn.addEventListener('click', function(ev) {
                ev.stopPropagation();
                thumbDiv.remove();
                window._zipImages[idx] = null;
                // Se n√£o houver mais thumbs, esconde grid e bot√£o ZIP
                if (!Array.from(thumbsGrid.children).some(child => child.style.display !== 'none')) {
                  thumbsGrid.classList.add('hidden');
                  document.getElementById('downloadZipBtn').classList.add('hidden');
                }
              });

              // Salvar fun√ß√£o para gerar imagem final (com infos) para o ZIP
              window._zipImages[idx] = () => generateCanvasUrl(img, infoToggle, exifForThis, idx);

              thumbsGrid.appendChild(thumbDiv);
            };
            img.src = evt.target.result;
          };
          reader.readAsDataURL(file);
        });
      });

      // Fun√ß√£o para gerar imagem final para o ZIP
      function generateCanvasUrl(img, infoToggle, exifForThis, idx) {
        // Descobre o formato escolhido
        let ratio = 1;
        let canvasW, canvasH;
        const selected = document.querySelector('input[name="outputRatio"]:checked');
        if (selected && selected.value === '9:16') {
          ratio = 9/16;
          canvasH = 1600;
          canvasW = Math.round(canvasH * ratio);
        } else {
          canvasW = canvasH = 1200;
        }
        // Foto ocupa no m√°ximo 90% do lado menor (moldura de 5% cada lado)
        const maxFoto = Math.min(canvasW, canvasH) * 0.9;
        let drawW = img.width, drawH = img.height;
        const scale = Math.min(maxFoto / img.width, maxFoto / img.height);
        drawW = img.width * scale;
        drawH = img.height * scale;
        const x = (canvasW - drawW) / 2;
        const y = (canvasH - drawH) / 2;
        const canvas = document.createElement('canvas');
        canvas.width = canvasW;
        canvas.height = canvasH;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, canvasW, canvasH);
        ctx.drawImage(img, x, y, drawW, drawH);
        // Infos
        if (infoToggle && infoToggle.checked && exifForThis) {
          ctx.save();
          // Ajuste autom√°tico do tamanho da fonte para caber as infos
          let maxFont = Math.round(canvasH * 0.03);
          let fontSize = maxFont;
          ctx.font = fontSize + 'px sans-serif';
          ctx.fillStyle = '#444';
          ctx.textAlign = 'center';
          // Medidas para ajuste
          let fits = false;
          if (img.height > img.width * 1.25) {
            // Lateral esquerda, vertical
            ctx.save();
            ctx.translate(canvasW * 0.04, canvasH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            // Reduz fonte at√© caber 90% da altura √∫til
            while (fontSize > 10) {
              ctx.font = fontSize + 'px sans-serif';
              if (ctx.measureText(exifForThis).width < canvasH * 0.9) { fits = true; break; }
              fontSize -= 1;
            }
            ctx.font = fontSize + 'px sans-serif';
            ctx.fillText(exifForThis, 0, 0);
            ctx.restore();
          } else {
            // Embaixo, centralizado
            // Se for stories (canvas 9:16), sobe as infos para n√£o ficar colado na base
            let yInfo = canvasH - canvasH * 0.15;
            if (canvasW === canvasH) {
              // 1:1, mant√©m na base
              yInfo = canvasH - canvasH * 0.03;
            }
            // Reduz fonte at√© caber 90% da largura √∫til
            while (fontSize > 10) {
              ctx.font = fontSize + 'px sans-serif';
              if (ctx.measureText(exifForThis).width < canvasW * 0.9) { fits = true; break; }
              fontSize -= 1;
            }
            ctx.font = fontSize + 'px sans-serif';
            ctx.fillText(exifForThis, canvasW / 2, yInfo);
          }
          ctx.restore();
        }
        return canvas.toDataURL('image/png');
      }

      // Fecha overlay ao clicar no bot√£o ou fora da imagem
      document.getElementById('closeOverlayBtn').addEventListener('click', function() {
        const overlay = document.getElementById('imageOverlay');
        overlay.classList.add('hidden');
        overlay.classList.remove('flex');
        document.getElementById('overlayImg').src = '';
      });
      document.getElementById('imageOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.add('hidden');
          this.classList.remove('flex');
          document.getElementById('overlayImg').src = '';
        }
      });

      // Mant√©m funcionalidade de preview e download para uma foto selecionada
      uploadForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const file = fileInput.files[0];
        if (!file) return;
        exifText = '';
        EXIF.getData(file, function () {
          const allExif = EXIF.getAllTags(this);
          exifText = getExifText(allExif);
          exifInfoDiv.textContent = exifText;
        });
        const reader = new FileReader();
        reader.onload = function (evt) {
          const img = new Image();
          img.onload = function () {
            imgOriginal = img;
            const previewQuad = PREVIEW_SIZE;
            const targetSize = previewQuad * IMG_RATIO;
            let drawWidth, drawHeight;
            if (img.width > img.height) {
              drawWidth = targetSize;
              drawHeight = (img.height / img.width) * targetSize;
            } else {
              drawHeight = targetSize;
              drawWidth = (img.width / img.height) * targetSize;
            }
            ctxPreview.clearRect(0, 0, PREVIEW_SIZE, PREVIEW_SIZE);
            ctxPreview.fillStyle = '#fff';
            ctxPreview.fillRect(0, 0, PREVIEW_SIZE, PREVIEW_SIZE);
            ctxPreview.drawImage(img, (PREVIEW_SIZE-drawWidth)/2, (PREVIEW_SIZE-drawHeight)/2, drawWidth, drawHeight);
            previewArea.classList.remove('hidden');
            finalImageReady = true;
          };
          img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      });

      downloadBtn.addEventListener('click', function () {
        if (!finalImageReady || !imgOriginal) return;
        const maxSide = Math.max(imgOriginal.width, imgOriginal.height);
        const quadSize = Math.round(maxSide / IMG_RATIO);
        const canvas = document.createElement('canvas');
        canvas.width = quadSize;
        canvas.height = quadSize;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, quadSize, quadSize);
        let drawWidth, drawHeight;
        if (imgOriginal.width > imgOriginal.height) {
          drawWidth = quadSize * IMG_RATIO;
          drawHeight = (imgOriginal.height / imgOriginal.width) * drawWidth;
        } else {
          drawHeight = quadSize * IMG_RATIO;
          drawWidth = (imgOriginal.width / imgOriginal.height) * drawHeight;
        }
        const x = (quadSize - drawWidth) / 2;
        const y = (quadSize - drawHeight) / 2;
        ctx.drawImage(imgOriginal, x, y, drawWidth, drawHeight);
        if (exifText) {
          ctx.font = Math.round(quadSize * 0.03) + 'px sans-serif';
          ctx.fillStyle = '#444';
          ctx.textAlign = 'center';
          ctx.fillText(exifText, quadSize / 2, quadSize - quadSize * 0.03);
        }
        const link = document.createElement('a');
        link.download = 'foto-moldurada-1x1.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });

      // Baixar todas em ZIP
      document.getElementById('downloadZipBtn').addEventListener('click', async function() {
        if (!window._zipImages || window._zipImages.length === 0) return;
        const zip = new JSZip();
        for (let i = 0; i < window._zipImages.length; i++) {
          if (typeof window._zipImages[i] === 'function') {
            const dataUrl = window._zipImages[i]();
            // Converte para blob
            const base64 = dataUrl.split(',')[1];
            zip.file(`foto-moldurada-1x1-${i+1}.png`, base64, {base64: true});
          }
        }
        const content = await zip.generateAsync({type: 'blob'});
        const url = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'fotos-molduradas.zip';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
      });
    </script>
  </body>
</html>
